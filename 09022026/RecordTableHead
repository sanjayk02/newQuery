const RecordTableHead: React.FC<RecordTableHeadProps & {
  onSortChange: (sortKey: string) => void;
  currentSortKey: string;
  currentSortDir: SortDir;
  headerCellStylesById?: Record<string, React.CSSProperties>;
}> = ({
  columns,
  onSortChange,
  currentSortKey,
  currentSortDir,
  headerCellStylesById = {},
}) => {

  const PHASES = ["mdl", "rig", "bld", "dsn", "ldv"] as const;

  const PHASE_COLUMN_ORDER: Record<string, string[]> = {
    mdl: ["mdl_work_status", "mdl_approval_status", "mdl_submitted_at", "mdl_take"],
    rig: ["rig_work_status", "rig_approval_status", "rig_submitted_at", "rig_take"],
    bld: ["bld_work_status", "bld_approval_status", "bld_submitted_at", "bld_take"],
    dsn: ["dsn_work_status", "dsn_approval_status", "dsn_submitted_at", "dsn_take"],
    ldv: ["ldv_work_status", "ldv_approval_status", "ldv_submitted_at", "ldv_take"],
  };

  const getSortDir = (key: string): SortDir =>
    currentSortKey === key ? currentSortDir : "none";

  const createSortHandler = (key: string) => () => onSortChange(key);

  return (
    <TableHead>
      <TableRow>
        {columns.map((column) => {
          // Detect phase
          const phase = PHASES.find(p => column.id.startsWith(p));
          const phaseOrder = phase ? PHASE_COLUMN_ORDER[phase] : [];

          const isFirstInPhase = phase && phaseOrder[0] === column.id;
          const isLastInPhase  = phase && phaseOrder[phaseOrder.length - 1] === column.id;

          const hasPhase = Boolean(phase && column.colors);
          const rail = hasPhase ? `3px solid ${column.colors!.lineColor}` : "none";

          const sortKey = column.sortKey || column.id;
          const sortDir = getSortDir(sortKey);

          return (
            <TableCell
              key={column.id}
              style={{
                backgroundColor: column.colors
                  ? column.colors.backgroundColor
                  : "#2a2a2a",
                color: "#fff",
                fontWeight: 600,
                whiteSpace: "nowrap",
                borderTop: hasPhase ? rail : "none",
                borderLeft: hasPhase && isFirstInPhase ? rail : "none",
                borderRight: hasPhase && isLastInPhase ? rail : "none",
                ...(headerCellStylesById[column.id] || {}),
              }}
            >
              {column.sortable ? (
                <TableSortLabel
                  active={sortDir !== "none"}
                  hideSortIcon
                  direction={sortDir === "desc" ? "desc" : "asc"}
                  onClick={createSortHandler(sortKey)}
                  IconComponent={() => (
                    <span
                      style={{
                        fontSize: 12,
                        fontWeight: 700,
                        marginLeft: 8,
                        userSelect: "none",
                      }}
                    >
                      {sortDir === "desc" ? "▼" : "▲"}
                    </span>
                  )}
                >
                  {column.label}
                </TableSortLabel>
              ) : (
                column.label
              )}
            </TableCell>
          );
        })}
      </TableRow>
    </TableHead>
  );
};
