/* _________________________________________________________________________________
  
  Module Name:
  AssetsDataTable.tsx
  
  Module Description:
  React component that renders a data table displaying asset information for a project.
  
  Details:
  - Fetches and displays asset thumbnails.
  - Supports sorting by various asset attributes.
  - Allows hiding/showing of specific columns.
  - Compact mode for minimal column display.

  * Update and Modification History:
    * - 29-10-2025 - SanjayK PSI - Initial creation sorting pagination implementation.
    * - 07-11-2025 - SanjayK PSI - Column visibility toggling implementation.
    * - 20-11-2025 - SanjayK PSI - Fixed typo in filter property names handling.
    * - 24-11-2025 - SanjayK PSI - Added detailed doc comments for functions and types.
    * - [Current Date] - Added proper empty value handling in sorting
    * - 02-02-2026 - SanjayK PSI - Added component field to Asset type for better component tracking.
    * - 06-02-2026 - SanjayK PSI - Added take field to ReviewInfo type for enhanced review tracking.
    * - [Current Date] - Implemented new header structure with phase blocks
    
  Function:
    * - AssetsDataTable: Main component rendering the assets data table.
    * - RecordTableHead: Renders the table header with sortable columns.
    * - AssetRow: Renders individual rows for each asset.
    * - Styled components for consistent theming.
    * - MultIineTooltipTableCell: Table cell with multi-line tooltip support.
    * - Constants for asset phases, approval statuses, and work statuses.
    * - Column definitions for the data table.
    * - NON_FIXED_IDS: Array of column IDs excluding fixed columns.
    * - isOnlyFixedVisible: Utility to check if only fixed columns are visible.
    * - TooltipTableCellProps: Props for the MultiLineTooltipTableCell component.
    * - Status: Type defining display name and color for statuses.
    * - Columns: Configuration for the data table columns.
    * - ASSET_PHASES, APPROVAL_STATUS, WORK_STATUS: Mappings for phases and statuses.
    * - getPhaseData: Utility to extract phase-related data from an asset.
    * - isHidden: Utility to check if a column is hidden.
    * - RecordTableHead: Renders the table header with sortable columns
  * 
  ___________________________________________________________________________________ */
import React from "react";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableRow,
  Tooltip,
  TableSortLabel,
  Box,
} from "@material-ui/core";
import {
  AssetRowProps,
  AssetsDataTableProps,
  Colors,
  Column,
  RecordTableHeadProps,
  SortDir,
  Asset,
} from "./types";
import { useFetchAssetThumbnails } from "./hooks";

const ASSET_PHASES: { [key: string]: Colors } = {
  mdl: {
    lineColor: '#3295fd',
    backgroundColor: '#354d68',
  },
  rig: {
    lineColor: '#c061fd',
    backgroundColor: '#5e3568',
  },
  bld: {
    lineColor: '#fc2f8c',
    backgroundColor: '#5a0028',
  },
  dsn: {
    lineColor: '#98f2fb',
    backgroundColor: '#045660',
  },
  ldv: {
    lineColor: '#fe5cff',
    backgroundColor: '#683566',
  },
};

type Status = Readonly<{
  displayName: string,
  color: string,
}>;

const APPROVAL_STATUS: { [key: string]: Status } = {
  check: {
    displayName: 'Check',
    color: '#ca25ed',
  },
  clientReview: {
    displayName: 'Client Review',
    color: '#005fbd',
  },
  dirReview: {
    displayName: 'Dir Review',
    color: '#007fff',
  },
  epdReview: {
    displayName: 'EPD Review',
    color: '#4fa7ff',
  },
  clientOnHold: {
    displayName: 'Client On Hold',
    color: '#d69b00',
  },
  dirOnHold: {
    displayName: 'Dir On Hold',
    color: '#ffcc00',
  },
  epdOnHold: {
    displayName: 'EPD On Hold',
    color: '#ffdd55',
  },
  execRetake: {
    displayName: 'Exec Retake',
    color: '#a60000',
  },
  clientRetake: {
    displayName: 'Client Retake',
    color: '#c60000',
  },
  dirRetake: {
    displayName: 'Dir Retake',
    color: '#ff0000',
  },
  epdRetake: {
    displayName: 'EPD Retake',
    color: '#ff4f4f',
  },
  clientApproved: {
    displayName: 'Client Approved',
    color: '#1d7c39',
  },
  dirApproved: {
    displayName: 'Dir Approved',
    color: '#27ab4f',
  },
  epdApproved: {
    displayName: 'EPD Approved',
    color: '#5cda82',
  },
  other: {
    displayName: 'Other',
    color: '#9a9a9a',
  },
  omit: {
    displayName: 'Omit',
    color: '#646464',
  },
  approved: {
    displayName: 'Approved',
    color: '#32cd32',
  },
  review: {
    displayName: 'Review',
    color: '#ffa500',
  },
};

const WORK_STATUS: { [key: string]: Status } = {
  check: { displayName: "Check", color: "#e287f5" },
  cgsvOnHold: { displayName: "CGSV On Hold", color: "#ffdd55" },
  svOnHold: { displayName: "SV On Hold", color: "#ffe373" },
  leadOnHold: { displayName: "Lead On Hold", color: "#fff04f" },
  cgsvRetake: { displayName: "CGSV Retake", color: "#ff4f4f" },
  svRetake: { displayName: "SV Retake", color: "#ff8080" },
  leadRetake: { displayName: "Lead Retake", color: "#ffbbbb" },
  cgsvApproved: { displayName: "CGSV Approved", color: "#5cda82" },
  svApproved: { displayName: "SV Approved", color: "#83e29f" },
  leadApproved: { displayName: "Lead Approved", color: "#b9eec9" },
  svOther: { displayName: "SV Other", color: "#9a9a9a" },
  leadOther: { displayName: "Lead Other", color: "#dbdbdb" },
  review: { displayName: "Review", color: "#ffa500" },
  inProgress: { displayName: "In Progress", color: "#00bfff" },
  notStarted: { displayName: "Not Started", color: "#d3d3d3" },
  approved: { displayName: "Approved", color: "#32cd32" },
};

const columns: Column[] = [
  { id: "thumbnail", label: "Thumbnail" },
  { id: "group_1_name", label: "Name", sortable: true, sortKey: "group_1" },

  { id: "mdl_work_status", label: "WORK", colors: ASSET_PHASES.mdl, sortable: true, sortKey: "mdl_work" },
  { id: "mdl_approval_status", label: "APPR", colors: ASSET_PHASES.mdl, sortable: true, sortKey: "mdl_appr" },
  { id: "mdl_submitted_at", label: "SUBMITTED", colors: ASSET_PHASES.mdl, sortable: true, sortKey: "mdl_submitted" },
  { id: "mdl_take", label: "TAKE", colors: ASSET_PHASES.mdl, sortable: true, sortKey: "mdl_take" },

  { id: "rig_work_status", label: "WORK", colors: ASSET_PHASES.rig, sortable: true, sortKey: "rig_work" },
  { id: "rig_approval_status", label: "APPR", colors: ASSET_PHASES.rig, sortable: true, sortKey: "rig_appr" },
  { id: "rig_submitted_at", label: "SUBMITTED", colors: ASSET_PHASES.rig, sortable: true, sortKey: "rig_submitted" },
  { id: "rig_take", label: "TAKE", colors: ASSET_PHASES.rig, sortable: true, sortKey: "rig_take" },

  { id: "bld_work_status", label: "WORK", colors: ASSET_PHASES.bld, sortable: true, sortKey: "bld_work" },
  { id: "bld_approval_status", label: "APPR", colors: ASSET_PHASES.bld, sortable: true, sortKey: "bld_appr" },
  { id: "bld_submitted_at", label: "SUBMITTED", colors: ASSET_PHASES.bld, sortable: true, sortKey: "bld_submitted" },
  { id: "bld_take", label: "TAKE", colors: ASSET_PHASES.bld, sortable: true, sortKey: "bld_take" },

  { id: "dsn_work_status", label: "WORK", colors: ASSET_PHASES.dsn, sortable: true, sortKey: "dsn_work" },
  { id: "dsn_approval_status", label: "APPR", colors: ASSET_PHASES.dsn, sortable: true, sortKey: "dsn_appr" },
  { id: "dsn_submitted_at", label: "SUBMITTED", colors: ASSET_PHASES.dsn, sortable: true, sortKey: "dsn_submitted" },
  { id: "dsn_take", label: "TAKE", colors: ASSET_PHASES.dsn, sortable: true, sortKey: "dsn_take" },

  { id: "ldv_work_status", label: "WORK", colors: ASSET_PHASES.ldv, sortable: true, sortKey: "ldv_work" },
  { id: "ldv_approval_status", label: "APPR", colors: ASSET_PHASES.ldv, sortable: true, sortKey: "ldv_appr" },
  { id: "ldv_submitted_at", label: "SUBMITTED", colors: ASSET_PHASES.ldv, sortable: true, sortKey: "ldv_submitted" },
  { id: "ldv_take", label: "TAKE", colors: ASSET_PHASES.ldv, sortable: true, sortKey: "ldv_take" },

  { id: "relation", label: "Relation", sortable: true, sortKey: "relation" },
  { id: "component", label: "Component", sortable: true, sortKey: "component" },
];

const NON_FIXED_IDS = columns.map(c => c.id).filter(id => id !== "thumbnail" && id !== "group_1_name");
const isOnlyFixedVisible = (hidden: Set<string>) => NON_FIXED_IDS.every(id => hidden.has(id));

type TooltipTableCellProps = {
  tooltipText: string;
  status: Status | undefined;
  leftBorderStyle: string;
  rightBorderStyle: string;
  bottomBorderStyle: string;
};

/**
 * Utility functions for consistent empty value handling
 */
const isEmptyValue = (value: any): boolean => {
  if (value === null || value === undefined) return true;
  const str = String(value).trim();
  return str === '' || str === '-' || str === '—' || str === 'null' || str === 'undefined';
};

const formatForDisplay = (value: any): string => {
  if (isEmptyValue(value)) return '—';
  return String(value).trim();
};

const MultiLineTooltipTableCell: React.FC<TooltipTableCellProps> = ({
  tooltipText, status, leftBorderStyle, rightBorderStyle, bottomBorderStyle = "none",
}) => {
  const [open, setOpen] = React.useState(false);
  const hasTooltipText = tooltipText && tooltipText.trim().length > 0;
  const statusText = status ? status.displayName : '—';

  return (
    <TableCell
      style={{
        color: status ? status.color : "",
        fontStyle: tooltipText === "" ? "normal" : "oblique",
        borderLeft: leftBorderStyle,
        borderRight: rightBorderStyle,
        borderBottom: bottomBorderStyle,
      }}
      onClick={hasTooltipText ? () => setOpen(true) : undefined}
    >
      {hasTooltipText ? (
        <Tooltip
          title={<div style={{ fontSize: "0.8rem", whiteSpace: "pre-wrap" }}>{tooltipText}</div>}
          onClose={() => setOpen(false)}
          open={open}
          arrow
        >
          <span>{statusText}</span>
        </Tooltip>
      ) : (
        <span>{statusText}</span>
      )}
    </TableCell>
  );
};

/**
 * New Header Structure Component
 */
const PhaseHeader: React.FC<{
  hiddenColumns: Set<string>;
  onSortChange: (sortKey: string) => void;
  currentSortKey: string;
  currentSortDir: SortDir;
}> = ({ hiddenColumns, onSortChange, currentSortKey, currentSortDir }) => {
  const phases = ['mdl', 'rig', 'bld', 'dsn', 'ldv'] as const;

  // Get phase columns that are visible
  const getVisiblePhaseColumns = (phase: string) => {
    return columns.filter(col => 
      col.id.startsWith(phase) && !hiddenColumns.has(col.id)
    );
  };

  // Get column width based on type
  const getColumnWidth = (columnId: string): string => {
    if (columnId.includes('submitted_at')) return '140px';
    if (columnId.includes('work_status') || columnId.includes('approval_status')) return '80px';
    if (columnId.includes('take')) return '90px';
    if (columnId === 'thumbnail') return '140px';
    if (columnId === 'group_1_name') return '220px';
    if (columnId === 'relation') return '120px';
    if (columnId === 'component') return '150px';
    return '100px';
  };

  return (
    <div style={{ 
      display: 'flex', 
      width: '100%',
      borderBottom: '2px solid #444'
    }}>
      {/* Left Fixed Columns */}
      <div style={{ display: 'flex' }}>
        {/* Thumbnail */}
        {!hiddenColumns.has('thumbnail') && (
          <div style={{
            width: getColumnWidth('thumbnail'),
            backgroundColor: '#2a2a2a',
            border: '1px solid #444',
            borderRight: 'none',
            textAlign: 'center',
            fontWeight: 'bold',
            color: '#fff',
            padding: '12px 8px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '0.9rem',
          }}>
            THUMBNAIL
          </div>
        )}
        
        {/* Name */}
        {!hiddenColumns.has('group_1_name') && (
          <div style={{
            width: getColumnWidth('group_1_name'),
            backgroundColor: '#2a2a2a',
            border: '1px solid #444',
            textAlign: 'center',
            fontWeight: 'bold',
            color: '#fff',
            padding: '12px 8px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '0.9rem',
          }}>
            NAME
          </div>
        )}
      </div>

      {/* Phase Columns */}
      {phases.map(phase => {
        const phaseColumns = getVisiblePhaseColumns(phase);
        if (phaseColumns.length === 0) return null;

        return (
          <div 
            key={phase} 
            style={{ 
              display: 'flex', 
              flexDirection: 'column',
              borderLeft: `solid 3px ${ASSET_PHASES[phase].lineColor}`,
              borderRight: `solid 3px ${ASSET_PHASES[phase].lineColor}`,
            }}
          >
            {/* Phase Header */}
            <div style={{
              backgroundColor: ASSET_PHASES[phase].backgroundColor,
              borderTop: `solid 3px ${ASSET_PHASES[phase].lineColor}`,
              textAlign: 'center',
              fontWeight: 'bold',
              color: '#fff',
              textTransform: 'uppercase',
              padding: '8px 4px',
              fontSize: '0.9rem',
              height: '36px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
            }}>
              {phase.toUpperCase()}
            </div>

            {/* Column Headers */}
            <div style={{ display: 'flex' }}>
              {phaseColumns.map((column, index) => {
                const isFirst = index === 0;
                const isLast = index === phaseColumns.length - 1;
                const isSubmitted = column.id.includes('submitted_at');
                const sortKey = column.sortKey || column.id;
                const sortDir = currentSortKey === sortKey ? currentSortDir : 'none';

                return (
                  <div 
                    key={column.id} 
                    style={{ 
                      display: 'flex', 
                      flexDirection: 'column',
                      width: getColumnWidth(column.id),
                      borderLeft: isFirst ? 'none' : '1px solid #555',
                      borderRight: isLast ? 'none' : '1px solid #555',
                    }}
                  >
                    {/* Main Column Label */}
                    <div
                      style={{
                        backgroundColor: ASSET_PHASES[phase].backgroundColor,
                        textAlign: 'center',
                        fontWeight: 600,
                        color: '#fff',
                        padding: '6px 2px',
                        cursor: column.sortable ? 'pointer' : 'default',
                        fontSize: '0.85rem',
                        height: '32px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        '&:hover': column.sortable ? {
                          backgroundColor: `${ASSET_PHASES[phase].backgroundColor}CC`,
                        } : {},
                      }}
                      onClick={column.sortable ? () => onSortChange(sortKey) : undefined}
                    >
                      {column.sortable ? (
                        <div style={{ 
                          display: 'flex', 
                          alignItems: 'center', 
                          justifyContent: 'center',
                          gap: '4px'
                        }}>
                          <span>{column.label}</span>
                          {sortDir !== 'none' && (
                            <span style={{ fontSize: '0.7rem' }}>
                              {sortDir === 'desc' ? '▼' : '▲'}
                            </span>
                          )}
                        </div>
                      ) : (
                        column.label
                      )}
                    </div>

                    {/* "AT" Label for Submitted Columns */}
                    {isSubmitted && (
                      <div style={{
                        backgroundColor: ASSET_PHASES[phase].backgroundColor,
                        textAlign: 'center',
                        fontWeight: 500,
                        color: '#ddd',
                        fontSize: '0.75rem',
                        padding: '2px',
                        borderBottom: `solid 3px ${ASSET_PHASES[phase].lineColor}`,
                        height: '20px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                      }}>
                        AT
                      </div>
                    )}

                    {/* Bottom border for non-submitted columns */}
                    {!isSubmitted && (
                      <div style={{
                        backgroundColor: ASSET_PHASES[phase].backgroundColor,
                        borderBottom: `solid 3px ${ASSET_PHASES[phase].lineColor}`,
                        height: '20px',
                      }} />
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        );
      })}

      {/* Right Fixed Columns */}
      <div style={{ display: 'flex' }}>
        {/* Relation */}
        {!hiddenColumns.has('relation') && (
          <div style={{
            width: getColumnWidth('relation'),
            backgroundColor: '#2a2a2a',
            border: '1px solid #444',
            borderLeft: 'none',
            textAlign: 'center',
            fontWeight: 'bold',
            color: '#fff',
            padding: '12px 8px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '0.9rem',
          }}>
            RELATION
          </div>
        )}
        
        {/* Component */}
        {!hiddenColumns.has('component') && (
          <div style={{
            width: getColumnWidth('component'),
            backgroundColor: '#2a2a2a',
            border: '1px solid #444',
            borderLeft: 'none',
            textAlign: 'center',
            fontWeight: 'bold',
            color: '#fff',
            padding: '12px 8px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '0.9rem',
          }}>
            COMPONENT
          </div>
        )}
      </div>
    </div>
  );
};

const AssetRow: React.FC<AssetRowProps & { hiddenColumns: Set<string>; compact: boolean }> = ({
  asset, thumbnails, dateTimeFormat, isLastRow, hiddenColumns, compact, phaseComponents, latestComponents,
}) => {
  const isHidden = (id: string) => hiddenColumns.has(id);

  const getPhaseData = (phase: string) => {
    const workStatusKey     = `${phase}_work_status` as keyof Asset;
    const approvalStatusKey = `${phase}_approval_status` as keyof Asset;
    const submittedAtKey    = `${phase}_submitted_at_utc` as keyof Asset;
    const takeKey          = `${phase}_take` as keyof Asset;

    const workStatusValue     = asset[workStatusKey];
    const approvalStatusValue = asset[approvalStatusKey];
    const submittedAtValue    = asset[submittedAtKey];
    const takeValue           = asset[takeKey];

    // Status lookup with fallback for empty values
    let workStatus: Status | undefined = undefined;
    if (!isEmptyValue(workStatusValue)) {
        const raw = String(workStatusValue);
        workStatus = WORK_STATUS[raw] || 
        WORK_STATUS[raw.toLowerCase()] || 
        WORK_STATUS[raw.charAt(0).toLowerCase() + raw.slice(1)];

        // Use a generic status if the key is not found
        if (!workStatus) {
            workStatus = WORK_STATUS.svOther;
        }
    }
    
    let approvalStatus: Status | undefined = undefined;
    if (!isEmptyValue(approvalStatusValue)) {
        const raw = String(approvalStatusValue);
        approvalStatus = APPROVAL_STATUS[raw] || 
        APPROVAL_STATUS[raw.toLowerCase()] || 
        APPROVAL_STATUS[raw.charAt(0).toLowerCase() + raw.slice(1)];

        // Use a generic status if the key is not found
        if (!approvalStatus) {
            approvalStatus = APPROVAL_STATUS.other;
        }
    }

    const submittedAt = !isEmptyValue(submittedAtValue) ? new Date(submittedAtValue as string) : null;
    const localTimeText = submittedAt ? dateTimeFormat.format(submittedAt) : '—';
    let takeText = '—';
    if (!isEmptyValue(takeValue)) {
      const rawTake = String(takeValue).trim();
      takeText = rawTake.slice(-4); // Last 4 characters as fallback
    }

    return { 
      workStatus, 
      approvalStatus, 
      localTimeText, 
      takeText,
      tooltipText: '',
    };
  };

  // function to get component display value
  const getComponentData = () => {
    // Check if component exists directly on the asset (from the API response)
    if (asset.component && !isEmptyValue(asset.component)) {
      const componentStr = String(asset.component).trim();
      // Clean underscores first, then format
      const cleanComponent = componentStr.replace(/^_+|_+$/g, '');
      return formatForDisplay(cleanComponent);
    }
    
    // Fallback to latestComponents if needed (for backward compatibility)
    const assetKey = `${asset.root}-${asset.relation}`;
    const component = latestComponents[assetKey];

    if (!component || component.length === 0) {
      return '—';
    }

    const componentNames = component.map(comp => {
      const compStr = String(comp.component).trim();
      const cleanComp = compStr.replace(/^_+|_+$/g, '');
      return formatForDisplay(cleanComp);
    }).filter(name => name !== '—'); // Remove empty display values
    
    return componentNames.join(', ') || '—';
  };
  
  const componentData = getComponentData();

  // Get column width helper
  const getColumnWidth = (columnId: string): string => {
    if (columnId.includes('submitted_at')) return '140px';
    if (columnId.includes('work_status') || columnId.includes('approval_status')) return '80px';
    if (columnId.includes('take')) return '90px';
    if (columnId === 'thumbnail') return '140px';
    if (columnId === 'group_1_name') return '220px';
    if (columnId === 'relation') return '120px';
    if (columnId === 'component') return '150px';
    return '100px';
  };

  return (
    <div style={{ 
      display: 'flex', 
      width: '100%',
      borderBottom: isLastRow ? '2px solid #444' : '1px solid #555',
      backgroundColor: isLastRow ? '#f9f9f9' : 'transparent',
    }}>
      {/* Thumbnail */}
      {!isHidden("thumbnail") && (
        <div style={{
          width: getColumnWidth('thumbnail'),
          minWidth: getColumnWidth('thumbnail'),
          maxWidth: getColumnWidth('thumbnail'),
          borderRight: '1px solid #555',
          padding: '8px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
        }}>
          {thumbnails[`${asset.group_1}-${asset.relation}`] ? (
            <img
              src={thumbnails[`${asset.group_1}-${asset.relation}`]}
              alt={`${asset.group_1} thumbnail`}
              style={{ width: "100px", height: "auto", maxHeight: "60px", objectFit: "contain" }}
            />
          ) : (
            <span style={{ color: '#999', fontSize: '0.8rem' }}>No Thumbnail</span>
          )}
        </div>
      )}

      {/* Name */}
      {!isHidden("group_1_name") && (
        <div style={{
          width: getColumnWidth('group_1_name'),
          minWidth: getColumnWidth('group_1_name'),
          borderRight: '1px solid #555',
          padding: '8px',
          display: 'flex',
          alignItems: 'center',
          fontWeight: 500,
          overflow: 'hidden',
          textOverflow: 'ellipsis',
          whiteSpace: 'nowrap',
        }}>
          {formatForDisplay(asset.group_1)}
        </div>
      )}

      {/* Phase Columns */}
      {(Object.entries(ASSET_PHASES) as Array<[string, { lineColor: string }]>).map(
        ([phase, { lineColor }]) => {
          const ids = {
            work: `${phase}_work_status`,
            appr: `${phase}_approval_status`,
            subm: `${phase}_submitted_at`,
            take: `${phase}_take`,
          };

          const visibleIds = [
            !isHidden(ids.work) ? ids.work : null,
            !isHidden(ids.appr) ? ids.appr : null,
            !isHidden(ids.subm) ? ids.subm : null,
            !isHidden(ids.take) ? ids.take : null,
          ].filter(Boolean) as string[];

          if (visibleIds.length === 0) return null;

          const firstId = visibleIds[0];
          const lastId = visibleIds[visibleIds.length - 1];
          
          const { workStatus, approvalStatus, localTimeText, takeText } = getPhaseData(phase);

          return (
            <React.Fragment key={`${asset.group_1}-${asset.relation}-${phase}`}>
              {/* WORK */}
              {!isHidden(ids.work) && (
                <div style={{
                  width: getColumnWidth(ids.work),
                  minWidth: getColumnWidth(ids.work),
                  borderLeft: firstId === ids.work ? `solid 3px ${lineColor}` : '1px solid #555',
                  borderRight: lastId === ids.work ? `solid 3px ${lineColor}` : '1px solid #555',
                  padding: '8px 4px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  textAlign: 'center',
                  color: workStatus ? workStatus.color : '#666',
                  fontWeight: workStatus ? 500 : 400,
                  fontSize: '0.85rem',
                }}>
                  {workStatus ? workStatus.displayName : '—'}
                </div>
              )}

              {/* APPR */}
              {!isHidden(ids.appr) && (
                <div style={{
                  width: getColumnWidth(ids.appr),
                  minWidth: getColumnWidth(ids.appr),
                  borderLeft: firstId === ids.appr ? 'none' : '1px solid #555',
                  borderRight: lastId === ids.appr ? `solid 3px ${lineColor}` : '1px solid #555',
                  padding: '8px 4px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  textAlign: 'center',
                  color: approvalStatus ? approvalStatus.color : '#666',
                  fontWeight: approvalStatus ? 500 : 400,
                  fontSize: '0.85rem',
                }}>
                  {approvalStatus ? approvalStatus.displayName : '—'}
                </div>
              )}

              {/* SUBMITTED */}
              {!isHidden(ids.subm) && (
                <div style={{
                  width: getColumnWidth(ids.subm),
                  minWidth: getColumnWidth(ids.subm),
                  borderLeft: firstId === ids.subm ? 'none' : '1px solid #555',
                  borderRight: lastId === ids.subm ? `solid 3px ${lineColor}` : '1px solid #555',
                  padding: '8px 4px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  textAlign: 'center',
                  fontSize: '0.85rem',
                }}>
                  {localTimeText}
                </div>
              )}

              {/* TAKE */}
              {!isHidden(ids.take) && (
                <div style={{
                  width: getColumnWidth(ids.take),
                  minWidth: getColumnWidth(ids.take),
                  borderLeft: firstId === ids.take ? 'none' : '1px solid #555',
                  borderRight: lastId === ids.take ? `solid 3px ${lineColor}` : '1px solid #555',
                  padding: '8px 4px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  textAlign: 'center',
                  fontSize: '0.85rem',
                  fontWeight: 500,
                }}>
                  {takeText}
                </div>
              )}
            </React.Fragment>
          );
        }
      )}

      {/* RELATION */}
      {!isHidden("relation") && !compact && (
        <div style={{
          width: getColumnWidth('relation'),
          minWidth: getColumnWidth('relation'),
          borderLeft: '1px solid #555',
          padding: '8px',
          display: 'flex',
          alignItems: 'center',
          fontSize: '0.85rem',
        }}>
          {formatForDisplay(asset.relation)}
        </div>
      )}

      {/* COMPONENT */}
      {!isHidden("component") && !compact && (
        <div style={{
          width: getColumnWidth('component'),
          minWidth: getColumnWidth('component'),
          borderLeft: '1px solid #555',
          padding: '8px',
          display: 'flex',
          alignItems: 'center',
          flexWrap: 'wrap',
          gap: '4px',
        }}>
          {componentData ? (
            componentData.split(', ').map((comp: string, index: number) => (
              <span
                key={index}
                style={{
                  padding: '2px 6px',
                  backgroundColor: '#e0e0e0',
                  borderRadius: '12px',
                  fontSize: '0.75rem',
                }}
              >
                {comp}
              </span>
            ))
          ) : '—'}
        </div>
      )}
    </div>
  );
};

const AssetsGroupedDataTable: React.FC<AssetsDataTableProps> = ({
  project,
  assets,
  tableFooter,
  dateTimeFormat,
  onSortChange,
  currentSortKey,
  currentSortDir,
  hiddenColumns = new Set(),
  latestComponents,
  phaseComponents,
}) => {
  if (!project) return null;

  const { thumbnails } = useFetchAssetThumbnails(project, assets);

  // Compact mode: only Thumbnail + Name visible
  const compact = isOnlyFixedVisible(hiddenColumns);

  return (
    <div style={{ width: '100%', overflowX: 'auto' }}>
      {/* Header */}
      <PhaseHeader
        hiddenColumns={hiddenColumns}
        onSortChange={onSortChange}
        currentSortKey={currentSortKey}
        currentSortDir={currentSortDir}
      />

      {/* Body */}
      <div style={{ width: '100%' }}>
        {assets.map((asset, index) => (
          <AssetRow
            key={`${asset.group_1}-${asset.relation}`}
            asset={asset}
            thumbnails={thumbnails}
            dateTimeFormat={dateTimeFormat}
            isLastRow={index === assets.length - 1}
            hiddenColumns={hiddenColumns}
            compact={compact}
            phaseComponents={phaseComponents}
            latestComponents={latestComponents}
          />
        ))}
      </div>

      {/* Footer */}
      {tableFooter && (
        <div style={{ marginTop: '16px' }}>
          {tableFooter}
        </div>
      )}
    </div>
  );
};

export default AssetsGroupedDataTable;
