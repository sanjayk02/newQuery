// front/delivery/reviewInfo.go
package delivery

import (
	"context"
	"fmt"
	"net/http"
	"strconv"
	"strings"
	"time"

	"github.com/PolygonPictures/central30-web/front/usecase"
	"github.com/gin-gonic/gin"
)

type ReviewInfo struct {
	usecase *usecase.ReviewInfo
}

func NewReviewInfo(uc *usecase.ReviewInfo) *ReviewInfo {
	return &ReviewInfo{
		usecase: uc,
	}
}

// ... [ALL EXISTING METHODS KEEP AS IS] ...

// ListAssetsPivot handles GET /api/projects/:project/reviews/assets/pivot
func (d *ReviewInfo) ListAssetsPivot(c *gin.Context) {
	// Create context with timeout
	ctx, cancel := context.WithTimeout(c.Request.Context(), 120*time.Second)
	defer cancel()

	// Extract project parameter
	project := c.Param("project")
	if project == "" {
		c.JSON(http.StatusBadRequest, gin.H{
			"message": "Project parameter is required",
		})
		return
	}

	// Parse query parameters
	perPage, _ := strconv.Atoi(c.DefaultQuery("per_page", "15"))
	page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
	sortKey := c.DefaultQuery("sort", "group_1")
	dir := c.DefaultQuery("dir", "ASC")
	view := c.DefaultQuery("view", "list")
	assetNameKey := c.Query("assetNameKey")
	root := c.DefaultQuery("root", "assets")
	preferredPhase := c.DefaultQuery("preferred_phase", "")

	// Parse array parameters
	approvalStatuses := c.QueryArray("approvalStatus")
	workStatuses := c.QueryArray("workStatus")

	// Apply limits for safety
	if perPage > 100 {
		perPage = 100
	}
	if perPage < 1 {
		perPage = 15
	}
	if page < 1 {
		page = 1
	}

	// Normalize direction
	dir = strings.ToUpper(dir)
	if dir != "ASC" && dir != "DESC" {
		dir = "ASC"
	}

	// Call usecase
	result, err := d.usecase.ListAssetsPivot(ctx, usecase.ListAssetsPivotParams{
		Project:          project,
		Root:             root,
		PreferredPhase:   preferredPhase,
		OrderKey:         sortKey,
		Direction:        dir,
		Page:             page,
		PerPage:          perPage,
		AssetNameKey:     assetNameKey,
		ApprovalStatuses: approvalStatuses,
		WorkStatuses:     workStatuses,
		View:             view,
	})

	if err != nil {
		fmt.Printf("ListAssetsPivot error: %v\n", err)
		
		// Check for timeout
		if strings.Contains(err.Error(), "context deadline") || 
		   strings.Contains(err.Error(), "timeout") {
			c.JSON(http.StatusGatewayTimeout, gin.H{
				"message": "Query timed out. Please try with fewer results or add filters.",
				"error":   err.Error(),
			})
		} else {
			c.JSON(http.StatusInternalServerError, gin.H{
				"message": "Failed to fetch asset pivot data",
				"error":   err.Error(),
			})
		}
		return
	}

	c.JSON(http.StatusOK, result)
}
