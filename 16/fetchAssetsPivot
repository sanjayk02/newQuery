/* ========================================================================
   Fetch Assets Pivoted API
   - New function to fetch pivoted assets with filtering and sorting
   - Replaces previous fetchAssets implementation with enhanced functionality
   - Retains original fetchAssets and fetchAssetReviewInfos for backward compatibility
   - Uses URLSearchParams for cleaner query parameter handling
   - Encodes project, asset, and relation parameters to ensure URL safety
   - Improved error handling and response validation
   - Maintains consistent coding style with async/await and fetch API
   - Added comments for clarity and maintainability
   - Add by PSI
  ====================================================================== */
export const fetchAssetsPivot = async (
  project: string,
  page: number,
  rowsPerPage: number,
  sortKey: string,
  sortDir: string, // 'asc' | 'desc'
  phase: string,   // 'mdl' | 'rig' | 'bld' | 'dsn' | 'ldv' | 'none' | ''
  assetNameKey: string,       // Name filter (prefix, case-insensitive)
  approvalStatuses: string[], // Approval filter (OR within set)
  workStatuses: string[],     // Work filter (OR within set)
  view: 'list' | 'grouped', // View mode: list or grouped
  signal?: AbortSignal | null,
): Promise<AssetsPivotResponse> => {
  const headers = getAuthHeader();
  let url = `/api/projects/${(project)}/reviews/assets/pivot`;

  const params = new URLSearchParams();
  params.set('per_page', String(rowsPerPage));
  params.set('page', String(page + 1));
  if (sortKey) params.set('sort', sortKey);
  if (sortDir) params.set('dir', sortDir.toUpperCase());
  if (phase)   params.set('phase', phase);

  // View mode parameter
  if (view) params.set('view', view);

  // âœ… Server expects these keys:
  // name (with name_mode=prefix), work (CSV), appr (CSV)
  const trimmed = (typeof assetNameKey === 'string' ? assetNameKey : '').trim();
  if (trimmed) {
    params.set('name', trimmed);
    params.set('name_mode', 'prefix'); // keep prefix per your spec
  }
  if (Array.isArray(workStatuses) && workStatuses.length > 0) {
    params.set('work', workStatuses.join(',')); // CSV
  }
  if (Array.isArray(approvalStatuses) && approvalStatuses.length > 0) {
    params.set('appr', approvalStatuses.join(',')); // CSV
  }

  url += `?${params.toString()}`;

  const res = await fetch(url, {
    method: 'GET',
    headers,
    mode: 'cors',
    signal: signal || undefined,
  });

  console.log('Fetching Assets Pivot with URL:', url); // Debug log

  if (res.status === 401) throw new AuthorizationError();
  if (!res.ok) throw new Error('Failed to fetch pivoted assets.');

  setNewToken(res);
  const json = (await res.json()) as AssetsPivotResponse;
  console.log('Pivot Response Json:', json); // Debug log
  if (json && typeof json === 'object' && Array.isArray((json as any).groups)) {
    console.log('Number of groups received:', (json as any).groups.length); // Debug log
  }
  return json;
};
