export const fetchAssetsPivot = async (
  project: string,
  page: number,
  rowsPerPage: number,
  sortKey: string,
  sortDir: string,
  phase: string,
  assetNameKey: string,
  approvalStatuses: string[],
  workStatuses: string[],
  view: 'list' | 'grouped',
  signal?: AbortSignal | null,
): Promise<AssetsPivotResponse> => {
  const headers = getAuthHeader();
  let url = `/api/projects/${encodeURIComponent(project)}/reviews/assets/pivot`;

  const params = new URLSearchParams();
  params.set('per_page', String(rowsPerPage));
  params.set('page', String(page + 1));
  if (sortKey && sortKey !== 'none') params.set('sort', sortKey);
  if (sortDir && sortDir !== 'none') params.set('dir', sortDir.toUpperCase());
  if (phase && phase !== 'none') params.set('phase', phase);

  // View mode parameter
  if (view) params.set('view', view);

  const trimmed = (typeof assetNameKey === 'string' ? assetNameKey : '').trim();
  if (trimmed) {
    params.set('name', trimmed);
    params.set('name_mode', 'prefix');
  }
  if (Array.isArray(workStatuses) && workStatuses.length > 0) {
    params.set('work', workStatuses.join(','));
  }
  if (Array.isArray(approvalStatuses) && approvalStatuses.length > 0) {
    params.set('appr', approvalStatuses.join(','));
  }

  url += `?${params.toString()}`;

  console.log('üîç [DEBUG] Fetch Assets Pivot:', {
    fullUrl: url,
    project,
    page,
    rowsPerPage,
    sortKey,
    sortDir,
    phase,
    assetNameKey: trimmed,
    approvalStatuses,
    workStatuses,
    view,
    queryParams: Object.fromEntries(params.entries())
  });

  try {
    const res = await fetch(url, {
      method: 'GET',
      headers,
      mode: 'cors',
      signal: signal || undefined,
    });

    console.log('üîç [DEBUG] Response Status:', res.status, res.statusText);

    if (res.status === 401) {
      console.error('‚ùå [DEBUG] 401 Unauthorized');
      throw new AuthorizationError();
    }
    
    if (!res.ok) {
      let errorBody = '';
      try {
        errorBody = await res.text();
        console.error('‚ùå [DEBUG] Response Error Body:', errorBody);
      } catch (e) {
        console.error('‚ùå [DEBUG] Could not read error response');
      }
      
      throw new Error(`Failed to fetch pivoted assets. Status: ${res.status} ${res.statusText}. ${errorBody}`);
    }

    setNewToken(res);
    const json = (await res.json()) as AssetsPivotResponse;
    
    console.log('‚úÖ [DEBUG] Pivot Response Success:', {
      hasData: !!json,
      assetsCount: json?.assets?.length || 0,
      groupsCount: json?.groups?.length || 0,
      total: json?.total || 0,
      responseKeys: Object.keys(json || {})
    });
    
    return json;
  } catch (error) {
    console.error('‚ùå [DEBUG] fetchAssetsPivot Catch Error:', error);
    if (error instanceof TypeError && error.message.includes('fetch')) {
      console.error('‚ùå [DEBUG] Network error - check CORS or server availability');
    }
    throw error;
  }
};
