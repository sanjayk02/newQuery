export const fetchAssetsPivot = async ({
  project,
  page,
  rowsPerPage,
  orderKey = 'group1_only',
  direction = 'ASC',
  root = 'assets',
  assetNameKey = '',
  approvalStatuses = [],
  workStatuses = [],
  preferredPhase = 'none',
  view = 'list',
  signal,
}: {
  project: string;
  page: number;
  rowsPerPage: number;
  orderKey?: string;
  direction?: string;
  root?: string;
  assetNameKey?: string;
  approvalStatuses?: string[];
  workStatuses?: string[];
  preferredPhase?: string;
  view?: 'list' | 'grouped';
  signal?: AbortSignal | null;
}): Promise<AssetsPivotResponse> => {
  const headers = getAuthHeader();
  
  // Correct endpoint - matches your main.go route
  let url = `/api/projects/${project}/reviews/assets/pivot`;
  
  const params = new URLSearchParams();
  
  // ‚úÖ CORRECT: Backend expects 'sort' not 'order_key'
  params.set('sort', orderKey);
  
  // ‚úÖ CORRECT: Backend expects 'dir' not 'direction'
  params.set('dir', direction.toUpperCase());
  
  // ‚úÖ CORRECT: Backend expects 'name' not 'asset_name_key'
  if (assetNameKey.trim()) {
    params.set('name', assetNameKey.trim());
  }
  
  // ‚úÖ CORRECT: Backend expects 'approval_status' not 'approvalStatuses'
  if (approvalStatuses.length > 0) {
    params.set('approval_status', approvalStatuses.join(','));
  }
  
  // ‚úÖ CORRECT: Backend expects 'work_status' not 'workStatuses'
  if (workStatuses.length > 0) {
    params.set('work_status', workStatuses.join(','));
  }
  
  // ‚úÖ CORRECT: Backend expects 'phase' not 'preferred_phase'
  if (preferredPhase && preferredPhase !== 'none') {
    params.set('phase', preferredPhase);
  }
  
  // Other parameters
  params.set('page', String(page)); // ‚úÖ Correct
  params.set('per_page', String(rowsPerPage)); // ‚úÖ Correct
  params.set('root', root); // ‚úÖ Correct
  params.set('view', view); // ‚úÖ Correct
  
  url += `?${params.toString()}`;
  
  console.log('üîç Fetching Assets Pivot with URL:', url); // Debug log
  
  const res = await fetch(url, {
    method: 'GET',
    headers,
    mode: 'cors',
    signal: signal || undefined,
  });

  if (res.status === 401) throw new AuthorizationError();
  if (!res.ok) {
    console.error('‚ùå Failed to fetch pivoted assets. Status:', res.status, 'Status Text:', res.statusText);
    throw new Error(`Failed to fetch pivoted assets: ${res.statusText}`);
  }

  setNewToken(res);
  const json = await res.json();
  console.log('‚úÖ Pivot Response JSON:', json); // Debug log
  
  return json as AssetsPivotResponse;
};
