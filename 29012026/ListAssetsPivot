WITH LatestPerPhase AS (
	SELECT
		ri.project,
		ri.root,
		ri.group_1,
		ri.relation,
		ri.phase,
		ri.work_status,
		ri.approval_status,
		ri.submitted_at_utc,
		ri.modified_at_utc,
		JSON_UNQUOTE(JSON_EXTRACT(ri.groups, '$[0]')) AS leaf_group
	FROM t_review_info ri
	WHERE ri.project = ?
	  AND ri.root = ?
	  AND ri.deleted = 0
	  AND (LOWER(ri.group_1) LIKE LOWER(?) OR ? = '')
	  AND ` + buildStatusWhereClause(approvalStatuses, workStatuses) + `
),

LatestOnly AS (
	SELECT *,
		ROW_NUMBER() OVER (
			PARTITION BY project, root, group_1, relation, phase
			ORDER BY modified_at_utc DESC
		) AS rn
	FROM LatestPerPhase
),

FilteredLatest AS (
	SELECT * FROM LatestOnly WHERE rn = 1
),

DistinctAssets AS (
	SELECT
		project,
		root,
		group_1,
		relation,
		COUNT(*) OVER () AS total_count
	FROM FilteredLatest
	GROUP BY project, root, group_1, relation
),

OrderedAssets AS (
	SELECT
		da.*,
		ROW_NUMBER() OVER (
			ORDER BY LOWER(da.group_1) ASC
		) AS asset_order
	FROM DistinctAssets da
),

PaginatedAssets AS (
	SELECT *
	FROM OrderedAssets
	WHERE asset_order > ? AND asset_order <= ?
),

Pivoted AS (
	SELECT
		pa.project,
		pa.root,
		pa.group_1,
		pa.relation,
		pa.total_count,
		pa.asset_order,

		MAX(CASE WHEN fl.phase = 'mdl' THEN fl.work_status END) AS mdl_work_status,
		MAX(CASE WHEN fl.phase = 'mdl' THEN fl.approval_status END) AS mdl_approval_status,
		MAX(CASE WHEN fl.phase = 'mdl' THEN fl.submitted_at_utc END) AS mdl_submitted_at_utc,

		MAX(CASE WHEN fl.phase = 'rig' THEN fl.work_status END) AS rig_work_status,
		MAX(CASE WHEN fl.phase = 'rig' THEN fl.approval_status END) AS rig_approval_status,
		MAX(CASE WHEN fl.phase = 'rig' THEN fl.submitted_at_utc END) AS rig_submitted_at_utc,

		MAX(CASE WHEN fl.phase = 'bld' THEN fl.work_status END) AS bld_work_status,
		MAX(CASE WHEN fl.phase = 'bld' THEN fl.approval_status END) AS bld_approval_status,
		MAX(CASE WHEN fl.phase = 'bld' THEN fl.submitted_at_utc END) AS bld_submitted_at_utc,

		MAX(CASE WHEN fl.phase = 'dsn' THEN fl.work_status END) AS dsn_work_status,
		MAX(CASE WHEN fl.phase = 'dsn' THEN fl.approval_status END) AS dsn_approval_status,
		MAX(CASE WHEN fl.phase = 'dsn' THEN fl.submitted_at_utc END) AS dsn_submitted_at_utc,

		MAX(CASE WHEN fl.phase = 'ldv' THEN fl.work_status END) AS ldv_work_status,
		MAX(CASE WHEN fl.phase = 'ldv' THEN fl.approval_status END) AS ldv_approval_status,
		MAX(CASE WHEN fl.phase = 'ldv' THEN fl.submitted_at_utc END) AS ldv_submitted_at_utc

	FROM PaginatedAssets pa
	LEFT JOIN FilteredLatest fl
		ON fl.project = pa.project
		AND fl.root = pa.root
		AND fl.group_1 = pa.group_1
		AND fl.relation = pa.relation
	GROUP BY
		pa.project, pa.root, pa.group_1, pa.relation,
		pa.total_count, pa.asset_order
)

SELECT *
FROM Pivoted
ORDER BY asset_order;
