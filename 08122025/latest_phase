WITH latest_phase AS (
    SELECT
        ri.project,
        ri.root,
        ri.group_1,
        ri.relation,
        ri.phase,
        ri.work_status,
        ri.approval_status,
        ri.submitted_at_utc,
        ri.modified_at_utc,

        JSON_UNQUOTE(JSON_EXTRACT(ri.groups, '$[0]')) AS leaf_group_name,

        gc.path AS group_category_path,
        SUBSTRING_INDEX(gc.path, '/', 1) AS top_group_node,

        ROW_NUMBER() OVER (
            PARTITION BY ri.project, ri.root, ri.group_1, ri.relation
            ORDER BY ri.modified_at_utc DESC
        ) rn

    FROM …
)
SELECT …
FROM latest_phase
WHERE rn = 1
ORDER BY priority …
