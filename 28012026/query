-- First get the count
SELECT COUNT(*) as total_count
FROM (
  SELECT 
    ROW_NUMBER() OVER (
      PARTITION BY root, project, group_1, relation
      ORDER BY 
        CASE WHEN phase = '' THEN 0 ELSE 1 END,
        modified_at_utc DESC
    ) AS rn
  FROM t_review_info
  WHERE project = 'rod'
    AND root = 'assets'
    AND deleted = 0
) AS sub
WHERE rn = 1;

-- Then get the data with LIMIT
SELECT 
  root,
  project,
  group_1,
  relation,
  phase,
  work_status,
  approval_status,
  submitted_at_utc,
  modified_at_utc,
  COALESCE(
    JSON_UNQUOTE(JSON_EXTRACT(`groups`, '$[0]')),
    'unknown'
  ) AS leaf_group_name
FROM (
  SELECT 
    ri.*,
    ROW_NUMBER() OVER (
      PARTITION BY ri.root, ri.project, ri.group_1, ri.relation
      ORDER BY 
        CASE WHEN ri.phase = '' THEN 0 ELSE 1 END,
        ri.modified_at_utc DESC
    ) AS rn
  FROM t_review_info ri
  WHERE ri.project = 'rod'
    AND ri.root = 'assets'
    AND ri.deleted = 0
) AS ranked
WHERE rn = 1
ORDER BY group_1, relation
LIMIT 1000;
