WITH filtered_reviews AS (
  SELECT 
    ri.*,
    -- Extract JSON once at the beginning for first query
    JSON_UNQUOTE(JSON_EXTRACT(ri.`groups`, '$[0]')) AS leaf_group_name
  FROM t_review_info ri
  WHERE ri.project = 'rod'
    AND ri.root = 'assets'
    AND ri.deleted = 0
    -- Add dynamic name condition if needed
),
latest_unseen AS (
  SELECT 
    fr.*,
    gcg.path AS group_leaf_path,
    gc.path AS group_category_path,
    SUBSTRING_INDEX(gc.path, '/', 1) AS top_group_node,
    -- First query's ordering logic
    ROW_NUMBER() OVER (
      PARTITION BY fr.root, fr.project, fr.group_1, fr.relation
      ORDER BY 
        CASE WHEN fr.phase = '' THEN 0 ELSE 1 END,
        fr.modified_at_utc DESC
    ) AS rn_unseen,
    -- Second query's ordering logic
    ROW_NUMBER() OVER (
      PARTITION BY fr.project, fr.root, fr.group_1, fr.relation, fr.phase
      ORDER BY fr.modified_at_utc DESC
    ) AS rn_phase
  FROM filtered_reviews fr
  LEFT JOIN t_group_category_group gcg
    ON gcg.project = fr.project
    AND gcg.deleted = 0
    AND gcg.path = fr.leaf_group_name
  LEFT JOIN t_group_category gc
    ON gc.id = gcg.group_category_id
    AND gc.deleted = 0
    AND gc.root = 'assets'
)
-- First query results
SELECT 
  root,
  project,
  group_1,
  relation,
  phase,
  work_status,
  submitted_at_utc,
  modified_at_utc,
  top_group_node
FROM latest_unseen
WHERE rn_unseen = 1
ORDER BY group_1, relation
LIMIT 1000;
