// api.ts

export const fetchAssetsPivot = async (
  project: string,
  page: number,
  rowsPerPage: number,
  sortKey: string,
  sortDir: string,
  phase: string,
  name: string,
  approval: string[],
  work: string[],
  viewMode: string,
  signal?: AbortSignal
) => {
  if (!project) return { assets: [], groups: [], total: 0 };

  const params = new URLSearchParams({
    per_page: String(rowsPerPage),
    page: String(page + 1),
    dir: sortDir,
    sort: sortKey,
    phase: phase || "none",
    view: viewMode,
  });

  if (name) params.append("name", name);
  approval.forEach(v => params.append("approval", v));
  work.forEach(v => params.append("work", v));

  const url = `/api/projects/${project}/reviews/assets/pivot?${params}`;

  try {
    const res = await fetch(url, { signal });

    if (!res.ok) {
      console.warn("Pivot fetch failed:", res.status);
      return { assets: [], groups: [], total: 0 };
    }

    return await res.json();
  } catch (err: any) {
    if (err.name === "AbortError") return { assets: [], groups: [], total: 0 };
    console.error("Pivot fetch crashed:", err);
    return { assets: [], groups: [], total: 0 };
  }
};
