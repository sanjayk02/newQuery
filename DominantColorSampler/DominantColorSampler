# -*- coding: utf-8 -*-
# Dominant Color Sampler for Maya (Python 2.7)

import os
import re
import maya.cmds as cmds


class DominantColorSampler(object):
    
    def __init__(self):
        pass
    
    def get_selected_shapes(self):
        selection = cmds.ls(sl=True, long=True) or []
        if not selection:
            return []
        
        shapes = []
        for obj in selection:
            if cmds.objectType(obj) == "mesh":
                shapes.append(obj)
            else:
                shape_list = cmds.listRelatives(
                    obj, 
                    shapes=True, 
                    fullPath=True, 
                    type="mesh"
                ) or []
                shapes.extend(shape_list)
        
        return shapes
    
    def get_shader_from_shape(self, shape):
        shading_groups = cmds.listConnections(shape, type='shadingEngine') or []
        if not shading_groups:
            return None
        
        materials = cmds.ls(
            cmds.listConnections(shading_groups[0]), 
            materials=True
        ) or []
        
        return materials[0] if materials else None
    
    def get_texture_from_shader(self, shader):
        color_attrs = ["color", "diffuseColor", "diffuseLitColor", 
                      "albedoColor", "baseColor", "outColor"]
        
        for attr in color_attrs:
            if cmds.attributeQuery(attr, node=shader, exists=True):
                connections = cmds.listConnections(
                    "%s.%s" % (shader, attr), 
                    type='file', 
                    source=True, 
                    destination=False
                )
                if connections:
                    return connections[0]
        
        return None
    
    def get_texture_path(self, file_node):
        if not cmds.objExists("%s.fileTextureName" % file_node):
            return None
        
        try:
            return cmds.getAttr("%s.fileTextureName" % file_node)
        except:
            return None
    
    def get_color_from_shader(self, shader):
        color_attrs = ["color", "diffuseColor", "diffuseLitColor", 
                      "albedoColor", "baseColor", "outColor"]
        
        for attr in color_attrs:
            if cmds.attributeQuery(attr, node=shader, exists=True):
                try:
                    color = cmds.getAttr("%s.%s" % (shader, attr))
                    if color:
                        if isinstance(color[0], (list, tuple)):
                            rgb = color[0]
                        else:
                            rgb = color[:3]
                        
                        return [int(c * 255) for c in rgb]
                except:
                    continue
        
        return None
    
    def resolve_udim_texture(self, texture_path):
        if not texture_path or not os.path.exists(os.path.dirname(texture_path)):
            return texture_path, None
        
        folder, filename = os.path.split(texture_path)
        
        if "<f>" in filename:
            base_regex = re.escape(filename).replace("\\<f\\>", r"(\d{4})")
            
            for fname in os.listdir(folder):
                match = re.match(base_regex, fname)
                if match:
                    udim_number = match.group(1)
                    resolved_path = os.path.join(folder, fname).replace("\\", "/")
                    return resolved_path, int(udim_number)
        
        elif "<UDIM>" in filename:
            base_regex = re.escape(filename).replace("\\<UDIM\\>", r"(\d{4})")
            
            for fname in os.listdir(folder):
                match = re.match(base_regex, fname)
                if match:
                    udim_number = match.group(1)
                    resolved_path = os.path.join(folder, fname).replace("\\", "/")
                    return resolved_path, int(udim_number)
        
        return texture_path, None
    
    def get_dominant_color_simple(self, image_path):
        if not os.path.exists(image_path):
            return [128, 128, 128]
        
        try:
            temp_file = cmds.createNode("file", name="temp_color_sampler")
            cmds.setAttr("%s.fileTextureName" % temp_file, image_path, type="string")
            
            samples = []
            for u in [0.3, 0.5, 0.7]:
                for v in [0.3, 0.5, 0.7]:
                    try:
                        # Python 2.7 compatible colorAtPoint
                        color = cmds.colorAtPoint(
                            "%s.outColor" % temp_file, 
                            u=u, v=v, 
                            o="RGB", 
                            x=1, y=1
                        )
                        if color:
                            samples.append([
                                int(color[0][0] * 255),
                                int(color[0][1] * 255),
                                int(color[0][2] * 255)
                            ])
                    except:
                        pass
            
            cmds.delete(temp_file)
            
            if samples:
                avg_r = sum(c[0] for c in samples) // len(samples)
                avg_g = sum(c[1] for c in samples) // len(samples)
                avg_b = sum(c[2] for c in samples) // len(samples)
                return [avg_r, avg_g, avg_b]
            
        except Exception as e:
            print "Color sampling error: %s" % e
        
        filename = os.path.basename(image_path).lower()
        color_map = {
            'red': [255, 0, 0],
            'green': [0, 255, 0],
            'blue': [0, 0, 255],
            'white': [255, 255, 255],
            'black': [0, 0, 0],
            'gray': [128, 128, 128],
        }
        
        for color_name, color_value in color_map.items():
            if color_name in filename:
                return color_value
        
        return [128, 128, 128]
    
    def get_dominant_color_for_selected(self):
        shapes = self.get_selected_shapes()
        if not shapes:
            cmds.warning("No mesh shapes selected.")
            return []
        
        results = []
        
        for shape in shapes:
            transform = cmds.listRelatives(shape, parent=True, fullPath=True)
            transform = transform[0] if transform else shape
            
            shader = self.get_shader_from_shape(shape)
            if not shader:
                print "No shader found for: %s" % shape
                continue
            
            file_node = self.get_texture_from_shader(shader)
            dominant_color = None
            texture_info = None
            
            if file_node:
                texture_path = self.get_texture_path(file_node)
                if texture_path:
                    resolved_path, udim = self.resolve_udim_texture(texture_path)
                    
                    if os.path.exists(resolved_path):
                        dominant_color = self.get_dominant_color_simple(resolved_path)
                        texture_info = {
                            "path": texture_path,
                            "resolved_path": resolved_path,
                            "udim": udim,
                            "file_node": file_node
                        }
                    else:
                        print "Texture not found: %s" % resolved_path
            
            if not dominant_color:
                dominant_color = self.get_color_from_shader(shader)
                if not dominant_color:
                    dominant_color = [128, 128, 128]
            
            uv_sets = cmds.polyUVSet(shape, query=True, allUVSets=True) or []
            
            result = {
                "object": transform,
                "shape": shape,
                "shader": shader,
                "dominant_color": dominant_color,
                "color_hex": "#%02x%02x%02x" % (
                    dominant_color[0], 
                    dominant_color[1], 
                    dominant_color[2]
                ),
                "uv_sets": uv_sets,
                "has_texture": file_node is not None,
                "texture_info": texture_info
            }
            
            results.append(result)
            
            print "Object: %s" % transform.split('|')[-1]
            print "  Shader: %s" % shader
            if texture_info:
                print "  Texture: %s" % os.path.basename(texture_info['path'])
                if texture_info['udim']:
                    print "  UDIM: %s" % texture_info['udim']
            print "  Dominant Color: RGB%s" % str(dominant_color)
            print "  Color Hex: %s" % result['color_hex']
            print "  UV Sets: %s" % len(uv_sets)
            print "-" * 40
        
        return results
    
    def print_color_summary(self, results):
        if not results:
            return
        
        print "\n" + "=" * 60
        print "DOMINANT COLOR SUMMARY"
        print "=" * 60
        
        for i, result in enumerate(results, 1):
            obj_name = result['object'].split('|')[-1]
            shader_name = result['shader'].split('|')[-1]
            color = result['dominant_color']
            
            print "%2s. %-30s %-25s RGB(%3s, %3s, %3s)  %s" % (
                i, obj_name, shader_name, 
                color[0], color[1], color[2],
                result['color_hex']
            )
        
        print "=" * 60


# -------------------------------------------------------
# Convenience functions
# -------------------------------------------------------

def get_dominant_colors():
    sampler = DominantColorSampler()
    results = sampler.get_dominant_color_for_selected()
    if results:
        sampler.print_color_summary(results)
    return results


# -------------------------------------------------------
# How to use in Maya Python 2.7:
# -------------------------------------------------------

"""
# Save this file as: dominant_color_sampler.py
# Then in Maya Script Editor:

# Option 1: Import and use
import dominant_color_sampler
sampler = dominant_color_sampler.DominantColorSampler()
results = sampler.get_dominant_color_for_selected()

# Option 2: Use convenience function
dominant_color_sampler.get_dominant_colors()

# Option 3: Quick one-liner
from dominant_color_sampler import get_dominant_colors
get_dominant_colors()
"""
