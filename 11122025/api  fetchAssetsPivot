// src/project/asset-data/api.ts
import { SortDir } from "./types";

// these already exist in your app; import from your auth/util module if needed
declare function getAuthHeader(): Record<string, string>;
declare class AuthorizationError extends Error {}
declare function setNewToken(res: Response): void;

export async function fetchAssetsPivot(
  projectKey: string,
  page: number,
  perPage: number,
  sort: string,
  dir: SortDir, // 'asc' | 'desc' | 'none'
  phase: string,
  signal?: AbortSignal | null,
  extra?: { name?: string; name_mode?: "prefix" | "exact"; work?: string; appr?: string }
): Promise<any> {
  const params = new URLSearchParams();
  params.set("page", String(page + 1));
  params.set("per_page", String(perPage));
  if (sort) params.set("sort", sort);
  if (dir && dir !== "none") params.set("dir", String(dir).toUpperCase());
  if (phase && phase !== "none") params.set("phase", phase);

  if (extra && typeof extra === "object") {
    if (extra.name) params.set("name", extra.name);
    if (extra.name_mode) params.set("name_mode", extra.name_mode);
    if (extra.work) params.set("work", extra.work);
    if (extra.appr) params.set("appr", extra.appr);
  }

  const url =
    "/api/projects/" +
    encodeURIComponent(projectKey) +
    "/reviews/assets/pivot?" +
    params.toString();

  // âœ… send Authorization header (Bearer ... or whatever getAuthHeader supplies)
  const headers: Record<string, string> =
    typeof getAuthHeader === "function" ? getAuthHeader() : {};
  headers.Accept = "application/json";

  const res = await fetch(url, {
    method: "GET",
    mode: "cors",
    headers,
    // If your auth is cookie/session based, uncomment this:
    // credentials: "include",
    signal: signal || undefined,
  });

  // keep your existing 401 flow so PrivateRoute can handle it
  if (res.status === 401) {
    throw new AuthorizationError("Unauthorized");
  }
  if (!res.ok) {
    throw new Error("Failed to fetch pivoted assets (" + res.status + ")");
  }

  if (typeof setNewToken === "function") setNewToken(res);
  return res.json();
}
