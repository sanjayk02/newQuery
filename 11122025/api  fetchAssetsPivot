import { AuthorizationError } from '../../auth/types';
import { getAuthHeader, setNewToken } from '../../auth/util';
import { Asset, ReviewInfo, AssetsPivotResponse } from './types';

// ... (fetchAssets, fetchAssetReviewInfos, fetchAssetThumbnail remain the same)

// Returns AssetsPivotResponse
export const fetchAssetsPivot = async (
  project: string,
  page: number,
  rowsPerPage: number,
  sortKey: string,
  sortDir: string, // 'asc' | 'desc'
  phase: string,   // 'mdl' | 'rig' | 'bld' | 'dsn' | 'ldv' | 'none' | ''
  assetNameKey: string,       // ADDED
  approvalStatuses: string[], // ADDED
  workStatuses: string[],     // ADDED
  signal?: AbortSignal | null,
): Promise<AssetsPivotResponse> => {
  const headers = getAuthHeader();

  // âœ… match backend route + encode project
  let url: string = `/api/projects/${encodeURIComponent(project)}/reviews/assets/pivot`;

  const params = new URLSearchParams();
  params.set('per_page', String(rowsPerPage));
  params.set('page', String(page + 1));

  if (sortKey) params.set('sort', sortKey);
  if (sortDir) params.set('dir', sortDir.toUpperCase()); // backend normalizes; upper is fine
  if (phase)   params.set('phase', phase);
  
  // ADDED: Filter parameters
  if (assetNameKey) params.set('asset_name_key', assetNameKey);
  approvalStatuses.forEach(status => params.append('approval_statuses', status));
  workStatuses.forEach(status => params.append('work_statuses', status));

  url += `?${params.toString()}`;

  const res = await fetch(url, {
    method: 'GET',
    headers,
    mode: 'cors',
    signal: signal || undefined,
  });

  if (res.status === 401) throw new AuthorizationError();
  if (!res.ok) throw new Error('Failed to fetch pivoted assets.');

  setNewToken(res);
  const json: AssetsPivotResponse = await res.json();
  console.log("Fetched pivoted assets:", json);
  return json;
};

// ... (rest of the file)
