// src/project/asset-data/api.ts
import { SortDir } from "./types";

export async function fetchAssetsPivot(
  projectKey: string,
  page: number,
  perPage: number,
  sort: string,
  dir: SortDir, // 'asc' | 'desc' | 'none'
  phase: string,
  signal?: AbortSignal | null,
  extra?: { name?: string; name_mode?: "prefix" | "exact"; work?: string; appr?: string }
): Promise<any> {
  const params = new URLSearchParams();
  params.set("page", String(page + 1));
  params.set("per_page", String(perPage));

  if (sort) params.set("sort", sort);
  if (dir && dir !== "none") params.set("dir", String(dir).toUpperCase());
  if (phase && phase !== "none") params.set("phase", phase);

  // ✅ no optional chaining here — safe manual checks
  if (extra && typeof extra === "object") {
    if (extra.name) params.set("name", extra.name);
    if (extra.name_mode) params.set("name_mode", extra.name_mode);
    if (extra.work) params.set("work", extra.work);
    if (extra.appr) params.set("appr", extra.appr);
  }

  const url = "/api/projects/" + encodeURIComponent(projectKey) +
              "/reviews/assets/pivot?" + params.toString();

  const res = await fetch(url, {
    method: "GET",
    mode: "cors",
    signal: signal || undefined,
  });

  if (!res.ok) {
    throw new Error("Failed to fetch pivoted assets (" + res.status + ")");
  }

  return res.json();
}
