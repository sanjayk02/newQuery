import React from 'react';
import {
  Button,
  Paper,
  TextField,
  Menu,
  Checkbox,
  List,
  ListItem,
  ListItemText,
  Collapse,
  Divider,
  Badge,
} from '@material-ui/core';
import { styled } from '@material-ui/core/styles';
import { ButtonProps } from '@material-ui/core/Button';
import { TextFieldProps } from '@material-ui/core/TextField';
import {
  FilterList as FilterListIcon,
  ExpandMore as ExpandMoreIcon,
  ExpandLess as ExpandLessIcon,
} from '@material-ui/icons';

/* ───────── styled components ───────── */

const StyledFilterDiv = styled('div')({
  minHeight: 70,
});

const StyledPaper = styled(Paper)({
  width: '100%',
  display: 'flex',
  flexDirection: 'column',
  overflow: 'auto',
});

const TopRow = styled('div')(({ theme }) => ({
  backgroundColor: theme.palette.background.paper,
  display: 'flex',
  flexDirection: 'row',
  alignItems: 'center',
}));

const LeftForm = styled('form')(({ theme }) => ({
  '& .MuiTextField-root': {
    margin: theme.spacing(1),
  },
}));

const SearchField = styled(TextField)({
  maxWidth: 200,
  minWidth: 180,
});

const RightButtons = styled('div')({
  flexGrow: 1,
  display: 'flex',
  justifyContent: 'flex-end',
  alignItems: 'center',
  gap: 8,
  margin: '8px 8px 4px 8px',
});

const FilterButton = styled(Button)({
  backgroundColor: '#1e9bd7',
  color: '#fff',
  textTransform: 'none',
  borderRadius: 6,
  padding: '4px 10px',
  minHeight: 32,
  '&:hover': { backgroundColor: '#1789be' },
});

/* ───────── props ───────── */

type FilterProps = {
  filterAssetName: string;
  onAssetNameChange: TextFieldProps['onChange'];
  onResetClick: ButtonProps['onClick'];

  // column visibility (from parent)
  visibleColumns: Record<string, boolean>;
  onToggleColumn: (id: string) => void;
};

/* ───────── main ───────── */

const AssetTableFilter: React.FC<FilterProps> = ({
  filterAssetName,
  onAssetNameChange,
  onResetClick,
  visibleColumns,
  onToggleColumn,
}) => {
  const handleFilterKeyPress: TextFieldProps['onKeyPress'] = (event) => {
    if (event.key === 'Enter') {
      event.preventDefault();
      return false;
    }
  };

  // Menu state
  const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);
  const openMenu = (e: React.MouseEvent<HTMLButtonElement>) =>
    setAnchorEl(e.currentTarget);
  const closeMenu = () => setAnchorEl(null);

  // Badge count (only Asset Name now)
  const activeFiltersCount = filterAssetName?.trim() ? 1 : 0;

  // Collapse state for groups
  const [openGroups, setOpenGroups] = React.useState<Record<string, boolean>>({
    MDL: true,
    RIG: true,
    BLD: true,
    DSN: true,
    LDV: true,
  });
  const toggleGroup = (key: keyof typeof openGroups) =>
    setOpenGroups((s) => ({ ...s, [key]: !s[key] }));

  // Fixed phase groups (exactly 3 items each)
  const COLUMN_GROUPS: {
    key: 'MDL' | 'RIG' | 'BLD' | 'DSN' | 'LDV';
    items: { id: string; label: string }[];
  }[] = [
    {
      key: 'MDL',
      items: [
        { id: 'mdl_work_status', label: 'MDL WORK' },
        { id: 'mdl_approval_status', label: 'MDL APPR' },
        { id: 'mdl_submitted_at', label: 'MDL SUBMITTED AT' },
      ],
    },
    {
      key: 'RIG',
      items: [
        { id: 'rig_work_status', label: 'RIG WORK' },
        { id: 'rig_approval_status', label: 'RIG APPR' },
        { id: 'rig_submitted_at', label: 'RIG SUBMITTED AT' },
      ],
    },
    {
      key: 'BLD',
      items: [
        { id: 'bld_work_status', label: 'BLD WORK' },
        { id: 'bld_approval_status', label: 'BLD APPR' },
        { id: 'bld_submitted_at', label: 'BLD SUBMITTED AT' },
      ],
    },
    {
      key: 'DSN',
      items: [
        { id: 'dsn_work_status', label: 'DSN WORK' },
        { id: 'dsn_approval_status', label: 'DSN APPR' },
        { id: 'dsn_submitted_at', label: 'DSN SUBMITTED AT' },
      ],
    },
    {
      key: 'LDV',
      items: [
        { id: 'ldv_work_status', label: 'LDV WORK' },
        { id: 'ldv_approval_status', label: 'LDV APPR' },
        { id: 'ldv_submitted_at', label: 'LDV SUBMITTED AT' },
      ],
    },
  ];

  return (
    <StyledFilterDiv>
      <StyledPaper>
        <TopRow>
          <LeftForm>
            <SearchField
              id="filter-assetname"
              type="search"
              label="Asset Name"
              value={filterAssetName}
              onChange={onAssetNameChange}
              onKeyPress={handleFilterKeyPress}
            />
          </LeftForm>

          <RightButtons>
            <FilterButton
              variant="contained"
              onClick={openMenu}
              startIcon={<FilterListIcon />}
              endIcon={<ExpandMoreIcon />}
            >
              Filter&nbsp;
              <Badge
                badgeContent={activeFiltersCount}
                color="secondary"
                max={99}
                overlap="rectangular"
              >
                <span style={{ display: 'inline-block', width: 0, height: 0 }} />
              </Badge>
            </FilterButton>

            <Button variant="outlined" onClick={onResetClick}>
              Reset
            </Button>
          </RightButtons>

          {/* Menu */}
          <Menu anchorEl={anchorEl} open={Boolean(anchorEl)} onClose={closeMenu} keepMounted>
            {/* Asset Name */}
            <div style={{ padding: '10px 16px', maxWidth: 280 }}>
              <TextField
                fullWidth
                label="Asset Name"
                value={filterAssetName}
                onChange={onAssetNameChange}
                onKeyPress={handleFilterKeyPress}
              />
            </div>

            <Divider />

            {/* Columns – grouped, collapse/expand */}
            <div style={{ padding: '6px 16px', fontWeight: 600, opacity: 0.85 }}>
              Columns
            </div>

            <List dense disablePadding>
              {COLUMN_GROUPS.map((grp, idx, arr) => (
                <React.Fragment key={`grp-${grp.key}`}>
                  <ListItem
                    button
                    onClick={() => toggleGroup(grp.key)}
                    style={{ padding: '6px 16px' }}
                  >
                    <ListItemText
                      primary={grp.key}
                      primaryTypographyProps={{
                        style: { fontWeight: 700, letterSpacing: 0.4 },
                      }}
                    />
                    {openGroups[grp.key] ? <ExpandLessIcon /> : <ExpandMoreIcon />}
                  </ListItem>

                  <Collapse in={openGroups[grp.key]} timeout="auto" unmountOnExit>
                    <List dense disablePadding style={{ paddingLeft: 24 }}>
                      {grp.items.map(({ id, label }) => (
                        <ListItem
                          key={`col-${id}`}
                          style={{ padding: '4px 16px' }}
                          onClick={(e) => {
                            e.stopPropagation();
                            onToggleColumn(id);
                          }}
                        >
                          <Checkbox
                            checked={!!visibleColumns[id]}
                            onChange={(e) => {
                              e.stopPropagation();
                              onToggleColumn(id);
                            }}
                          />
                          <ListItemText primary={label} secondary={id} />
                        </ListItem>
                      ))}
                    </List>
                  </Collapse>

                  {/* dashed separator */}
                  {idx < arr.length - 1 && (
                    <div
                      style={{
                        margin: '4px 16px',
                        opacity: 0.35,
                        userSelect: 'none',
                      }}
                    >
                      --------------------------------
                    </div>
                  )}
                </React.Fragment>
              ))}
            </List>
          </Menu>
        </TopRow>
      </StyledPaper>
    </StyledFilterDiv>
  );
};

export default AssetTableFilter;
