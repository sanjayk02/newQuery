import React from 'react';
import {
  Button,
  Paper,
  Menu,
  Checkbox,
  List,
  ListItem,
  ListItemText,
  Collapse,
  Divider,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  SelectProps,
} from '@material-ui/core';
import { styled } from '@material-ui/core/styles';
import { ButtonProps } from '@material-ui/core/Button';
import { TextFieldProps } from '@material-ui/core/TextField';
import {
  FilterList as FilterListIcon,
  ExpandMore as ExpandMoreIcon,
  ExpandLess as ExpandLessIcon,
} from '@material-ui/icons';

/* ───────── styled components ───────── */

const StyledFilterDiv = styled('div')({
  minHeight: 70,
});

const StyledPaper = styled(Paper)({
  width: '100%',
  display: 'flex',
  flexDirection: 'column',
  overflow: 'auto',
});

const TopRow = styled('div')(({ theme }) => ({
  backgroundColor: theme.palette.background.paper,
  display: 'flex',
  flexDirection: 'row',
  alignItems: 'center',
  padding: '6px 8px',
  gap: 8,
}));

const LeftControls = styled('div')({
  display: 'flex',
  alignItems: 'center',
  gap: 12,
  flexWrap: 'wrap',
  minHeight: 40,
});

const RightButtons = styled('div')({
  marginLeft: 'auto',
  display: 'flex',
  alignItems: 'center',
  gap: 8,
});

const FilterButton = styled(Button)({
  backgroundColor: '#1e9bd7',
  color: '#fff',
  textTransform: 'none',
  borderRadius: 6,
  padding: '4px 10px',
  minHeight: 32,
  '&:hover': { backgroundColor: '#1789be' },
});

const SmallField = styled(TextField)({
  minWidth: 200,
  maxWidth: 240,
});

const SmallFormControl = styled(FormControl)({
  minWidth: 180,
});

/* ───────── options (static) ───────── */

const APPROVAL_OPTIONS = [
  'check',
  'clientReview',
  'dirReview',
  'epdReview',
  'clientOnHold',
  'dirOnHold',
  'epdOnHold',
  'execRetake',
  'clientRetake',
  'dirRetake',
  'epdRetake',
  'clientApproved',
  'dirApproved',
  'epdApproved',
  'other',
  'omit',
];

const WORK_OPTIONS = [
  'check',
  'cgsvOnHold',
  'svOnHold',
  'leadOnHold',
  'cgsvRetake',
  'svRetake',
  'leadRetake',
  'cgsvApproved',
  'svApproved',
  'leadApproved',
  'svOther',
  'leadOther',
];

/* ───────── props ───────── */

type FilterProps = {
  filterAssetName: string;
  approvalStatuses: string[];            // selected values
  workStatuses: string[];                // selected values
  onAssetNameChange: TextFieldProps['onChange'];
  onApprovalStatusesChange: SelectProps['onChange'];
  onWorkStatusesChange: SelectProps['onChange'];
  onResetClick: ButtonProps['onClick'];

  // column visibility (from parent)
  visibleColumns: Record<string, boolean>;
  onToggleColumn: (id: string) => void;
};

/* ───────── main ───────── */

const AssetTableFilter: React.FC<FilterProps> = ({
  filterAssetName,
  approvalStatuses,
  workStatuses,
  onAssetNameChange,
  onApprovalStatusesChange,
  onWorkStatusesChange,
  onResetClick,
  visibleColumns,
  onToggleColumn,
}) => {
  // Menu state
  const [anchorEl, setAnchorEl] = React.useState<null | HTMLElement>(null);
  const openMenu = (e: React.MouseEvent<HTMLButtonElement>) =>
    setAnchorEl(e.currentTarget);
  const closeMenu = () => setAnchorEl(null);

  // Collapse state for groups in the menu
  const [openGroups, setOpenGroups] = React.useState<Record<string, boolean>>({
    MDL: true,
    RIG: true,
    BLD: true,
    DSN: true,
    LDV: true,
  });
  const toggleGroup = (key: keyof typeof openGroups) =>
    setOpenGroups((s) => ({ ...s, [key]: !s[key] }));

  // Fixed phase groups (3 items each)
  const COLUMN_GROUPS: {
    key: 'MDL' | 'RIG' | 'BLD' | 'DSN' | 'LDV';
    items: { id: string; label: string }[];
  }[] = [
    {
      key: 'MDL',
      items: [
        { id: 'mdl_work_status', label: 'MDL WORK' },
        { id: 'mdl_approval_status', label: 'MDL APPR' },
        { id: 'mdl_submitted_at', label: 'MDL SUBMITTED AT' },
      ],
    },
    {
      key: 'RIG',
      items: [
        { id: 'rig_work_status', label: 'RIG WORK' },
        { id: 'rig_approval_status', label: 'RIG APPR' },
        { id: 'rig_submitted_at', label: 'RIG SUBMITTED AT' },
      ],
    },
    {
      key: 'BLD',
      items: [
        { id: 'bld_work_status', label: 'BLD WORK' },
        { id: 'bld_approval_status', label: 'BLD APPR' },
        { id: 'bld_submitted_at', label: 'BLD SUBMITTED AT' },
      ],
    },
    {
      key: 'DSN',
      items: [
        { id: 'dsn_work_status', label: 'DSN WORK' },
        { id: 'dsn_approval_status', label: 'DSN APPR' },
        { id: 'dsn_submitted_at', label: 'DSN SUBMITTED AT' },
      ],
    },
    {
      key: 'LDV',
      items: [
        { id: 'ldv_work_status', label: 'LDV WORK' },
        { id: 'ldv_approval_status', label: 'LDV APPR' },
        { id: 'ldv_submitted_at', label: 'LDV SUBMITTED AT' },
      ],
    },
  ];

  return (
    <StyledFilterDiv>
      <StyledPaper>
        <TopRow>
          {/* LEFT: inline controls (as in your screenshot) */}
          <LeftControls>
            <SmallField
              label="Asset Name"
              type="search"
              value={filterAssetName}
              onChange={onAssetNameChange}
            />
            <SmallFormControl>
              <InputLabel id="appr-label">Approval Status</InputLabel>
              <Select
                labelId="appr-label"
                value={approvalStatuses}
                multiple
                onChange={onApprovalStatusesChange}
              >
                {APPROVAL_OPTIONS.map((opt) => (
                  <MenuItem key={opt} value={opt}>
                    {opt}
                  </MenuItem>
                ))}
              </Select>
            </SmallFormControl>
            <SmallFormControl>
              <InputLabel id="work-label">Work Status</InputLabel>
              <Select
                labelId="work-label"
                value={workStatuses}
                multiple
                onChange={onWorkStatusesChange}
              >
                {WORK_OPTIONS.map((opt) => (
                  <MenuItem key={opt} value={opt}>
                    {opt}
                  </MenuItem>
                ))}
              </Select>
            </SmallFormControl>
          </LeftControls>

          {/* RIGHT: Filter (columns menu) + Reset */}
          <RightButtons>
            <FilterButton
              variant="contained"
              onClick={openMenu}
              startIcon={<FilterListIcon />}
              endIcon={<ExpandMoreIcon />}
            >
              Filter
            </FilterButton>
            <Button variant="outlined" onClick={onResetClick}>
              Reset
            </Button>
          </RightButtons>

          {/* MENU: Columns only (collapsible groups) */}
          <Menu anchorEl={anchorEl} open={Boolean(anchorEl)} onClose={closeMenu} keepMounted>
            <div style={{ padding: '6px 16px', fontWeight: 600, opacity: 0.85 }}>
              Columns
            </div>

            <List dense disablePadding>
              {COLUMN_GROUPS.map((grp, idx, arr) => (
                <React.Fragment key={`grp-${grp.key}`}>
                  {/* Group header (collapse/expand) */}
                  <ListItem
                    button
                    onClick={() => toggleGroup(grp.key)}
                    style={{ padding: '6px 16px' }}
                  >
                    <ListItemText
                      primary={grp.key}
                      primaryTypographyProps={{
                        style: { fontWeight: 700, letterSpacing: 0.4 },
                      }}
                    />
                    {openGroups[grp.key] ? <ExpandLessIcon /> : <ExpandMoreIcon />}
                  </ListItem>

                  {/* Group body */}
                  <Collapse in={openGroups[grp.key]} timeout="auto" unmountOnExit>
                    <List dense disablePadding style={{ paddingLeft: 24 }}>
                      {grp.items.map(({ id, label }) => (
                        <ListItem
                          key={`col-${id}`}
                          style={{ padding: '4px 16px' }}
                          onClick={(e) => {
                            e.stopPropagation();
                            onToggleColumn(id);
                          }}
                        >
                          <Checkbox
                            checked={!!visibleColumns[id]}
                            onChange={(e) => {
                              e.stopPropagation();
                              onToggleColumn(id);
                            }}
                          />
                          {/* label only */}
                          <ListItemText primary={label} />
                        </ListItem>
                      ))}
                    </List>
                  </Collapse>

                  {/* dashed separator */}
                  {idx < arr.length - 1 && (
                    <div
                      style={{
                        margin: '4px 16px',
                        opacity: 0.35,
                        userSelect: 'none',
                      }}
                    >
                      --------------------------------
                    </div>
                  )}
                </React.Fragment>
              ))}
            </List>

            <Divider />
          </Menu>
        </TopRow>
      </StyledPaper>
    </StyledFilterDiv>
  );
};

export default AssetTableFilter;
