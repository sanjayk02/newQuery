WITH latest AS (
  SELECT project, root, group_1, relation, phase,
         MAX(modified_at_utc) AS modified_at_utc
  FROM t_review_info
  WHERE project='potoo' AND root='assets' AND relation='com' AND deleted=0
  GROUP BY project, root, group_1, relation, phase
),
joined AS (
  SELECT b.*
  FROM latest a
  JOIN t_review_info b
    ON a.project=b.project AND a.root=b.root
   AND a.group_1=b.group_1 AND a.relation=b.relation
   AND a.phase=b.phase AND a.modified_at_utc=b.modified_at_utc
),
ordered AS (
  SELECT j.*,
         ROW_NUMBER() OVER (
           ORDER BY j.submitted_at_utc DESC, j.id ASC  -- choose a single timeline + tiebreaker
         ) AS _order
  FROM joined j
),
offset_ordered AS (
  SELECT o.*,
         CASE WHEN o.phase='mdl' THEN o._order ELSE 100000 + o._order END AS __order
  FROM ordered o
),
ranked AS (
  SELECT x.*,
         ROW_NUMBER() OVER (
           PARTITION BY x.root,x.project,x.group_1,x.relation
           ORDER BY CASE WHEN x.phase='mdl' THEN 0 ELSE 1 END,
                    x.submitted_at_utc DESC, x.id ASC
         ) AS _rank
  FROM offset_ordered x
)
SELECT root, project, group_1, relation
FROM ranked
WHERE _rank=1
ORDER BY __order
LIMIT 15 OFFSET 0;
