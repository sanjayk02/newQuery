-- First, let's get only the necessary rows before processing
WITH filtered_reviews AS (
  SELECT 
    id,
    project,
    root,
    `groups`,
    phase,
    group_1,
    relation,
    work_status,
    submitted_at_utc,
    modified_at_utc
  FROM t_review_info
  WHERE project = 'hm'
    AND root = 'assets'
    AND deleted = 0
    -- Optional: Add date filter if appropriate
    -- AND modified_at_utc > '2024-01-01'
),
review_groups AS (
  SELECT 
    fr.id,
    fr.project,
    fr.root,
    -- Optimized group extraction
    CASE 
      -- Only process if groups is not empty
      WHEN fr.`groups` IS NOT NULL 
           AND fr.`groups` != ''
           AND fr.`groups` != '[]' THEN
        CASE 
          -- Check if it starts with [ (JSON array)
          WHEN LEFT(fr.`groups`, 1) = '[' THEN
            TRIM(BOTH '"' FROM 
              SUBSTRING_INDEX(
                SUBSTRING_INDEX(
                  SUBSTRING(fr.`groups`, 2, LENGTH(fr.`groups`) - 2),
                  ',', 1
                ),
                ',', -1
              )
            )
          -- Check if it's a simple string
          WHEN fr.`groups` LIKE '%,%' THEN
            TRIM(SUBSTRING_INDEX(fr.`groups`, ',', 1))
          ELSE
            TRIM(fr.`groups`)
        END
      ELSE NULL
    END AS first_group_name
  FROM filtered_reviews fr
  WHERE fr.`groups` IS NOT NULL 
    AND fr.`groups` != ''
    AND fr.`groups` != '[]'
),
ranked_reviews AS (
  SELECT 
    fr.*,
    rg.first_group_name,
    gcg.path AS group_leaf_path,
    gc.path AS group_category_path,
    CASE 
      WHEN gc.path IS NOT NULL THEN SUBSTRING_INDEX(gc.path, '/', 1)
      ELSE 'uncategorized'
    END AS top_group_node,
    
    ROW_NUMBER() OVER (
      PARTITION BY fr.root, fr.project, fr.group_1, fr.relation
      ORDER BY 
        CASE WHEN fr.phase = '' OR fr.phase IS NULL THEN 0 ELSE 1 END,
        fr.modified_at_utc DESC
    ) AS rn
  FROM filtered_reviews fr
  LEFT JOIN review_groups rg
    ON rg.id = fr.id
    AND rg.project = fr.project
    AND rg.root = fr.root
  LEFT JOIN t_group_category_group gcg
    ON gcg.project = fr.project
    AND gcg.deleted = 0
    AND gcg.path = rg.first_group_name
  LEFT JOIN t_group_category gc
    ON gc.id = gcg.group_category_id
    AND gc.deleted = 0
    AND gc.root = 'assets'
)
SELECT 
  root,
  project,
  group_1,
  relation,
  COALESCE(phase, '') as phase,
  work_status,
  submitted_at_utc,
  modified_at_utc,
  top_group_node,
  group_leaf_path,
  group_category_path,
  first_group_name
FROM ranked_reviews
WHERE rn = 1
ORDER BY 
  CASE WHEN COALESCE(phase, '') = '' THEN 0 ELSE 1 END,
  group_1 ASC,
  relation ASC
LIMIT 1000 OFFSET 0;
