func (r *ReviewInfo) CountLatestSubmissions(
    ctx context.Context,
    project, root, assetNameKey string,
    preferredPhase string,
    approvalStatuses []string,
    workStatuses []string,
) (int64, error) {
    if project == "" {
        return 0, fmt.Errorf("project is required")
    }
    if root == "" {
        root = "assets"
    }

    db := r.db.WithContext(ctx)

    // SIMPLIFIED COUNT QUERY - Much faster than the CTE approach
    sql := `
SELECT COUNT(DISTINCT CONCAT(group_1, '|', relation))
FROM t_review_info
WHERE project = ? AND root = ? AND deleted = 0
`
    
    args := []any{project, root}
    
    // Add name filter if provided
    if strings.TrimSpace(assetNameKey) != "" {
        sql += " AND LOWER(group_1) LIKE ?"
        args = append(args, strings.ToLower(strings.TrimSpace(assetNameKey))+"%")
    }
    
    // Add status filters
    if len(approvalStatuses) > 0 || len(workStatuses) > 0 {
        // For count, we need a subquery to check latest records
        // This is more complex but still faster than the CTE
        sql = `
SELECT COUNT(*)
FROM (
    SELECT group_1, relation
    FROM t_review_info
    WHERE project = ? AND root = ? AND deleted = 0
    `
        args := []any{project, root}
        
        if strings.TrimSpace(assetNameKey) != "" {
            sql += " AND LOWER(group_1) LIKE ?"
            args = append(args, strings.ToLower(strings.TrimSpace(assetNameKey))+"%")
        }
        
        sql += `
    GROUP BY group_1, relation
    HAVING 1=1
    `
        
        // Add status filters in HAVING clause
        if len(approvalStatuses) > 0 {
            sql += " AND MAX(CASE WHEN phase = ? THEN LOWER(approval_status) ELSE '' END) IN (?" + strings.Repeat(",?", len(approvalStatuses)-1) + ")"
            args = append(args, preferredPhase)
            for _, s := range approvalStatuses {
                args = append(args, strings.ToLower(strings.TrimSpace(s)))
            }
        }
        
        if len(workStatuses) > 0 {
            sql += " AND MAX(CASE WHEN phase = ? THEN LOWER(work_status) ELSE '' END) IN (?" + strings.Repeat(",?", len(workStatuses)-1) + ")"
            args = append(args, preferredPhase)
            for _, s := range workStatuses {
                args = append(args, strings.ToLower(strings.TrimSpace(s)))
            }
        }
        
        sql += ") AS x"
    }

    var total int64
    if err := db.Raw(sql, args...).Scan(&total).Error; err != nil {
        return 0, fmt.Errorf("CountLatestSubmissions: %w", err)
    }

    return total, nil
}
