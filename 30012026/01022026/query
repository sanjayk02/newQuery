WITH review_groups AS (
  SELECT 
    id,
    project,
    root,
    -- Extract first group name safely
    CASE 
      WHEN `groups` LIKE '%[%' THEN 
        TRIM(BOTH '"' FROM SUBSTRING_INDEX(
          SUBSTRING_INDEX(REPLACE(REPLACE(`groups`, '[', ''), ']', ''), 
          ',', 1), ',', -1))
      ELSE NULL
    END AS first_group_name
  FROM t_review_info
  WHERE `groups` IS NOT NULL 
    AND `groups` != ''
),
latest_reviews AS (
  SELECT 
    ri.*,
    rg.first_group_name,
    gcg.path AS group_leaf_path,
    gc.path AS group_category_path,
    CASE 
      WHEN gc.path IS NOT NULL THEN SUBSTRING_INDEX(gc.path, '/', 1)
      ELSE 'uncategorized'
    END AS top_group_node,
    
    ROW_NUMBER() OVER (
      PARTITION BY ri.root, ri.project, ri.group_1, ri.relation
      ORDER BY 
        CASE WHEN ri.phase = '' OR ri.phase IS NULL THEN 0 ELSE 1 END,
        ri.modified_at_utc DESC
    ) AS rn
  FROM t_review_info ri
  LEFT JOIN review_groups rg
    ON rg.id = ri.id
    AND rg.project = ri.project
    AND rg.root = ri.root
  LEFT JOIN t_group_category_group gcg
    ON gcg.project = ri.project
    AND gcg.deleted = 0
    AND gcg.path = rg.first_group_name
  LEFT JOIN t_group_category gc
    ON gc.id = gcg.group_category_id
    AND gc.deleted = 0
    AND gc.root = 'assets'
  WHERE ri.project = 'hm'
    AND ri.root = 'assets'
    AND ri.deleted = 0
)
SELECT 
  root,
  project,
  group_1,
  relation,
  COALESCE(phase, '') as phase,
  work_status,
  submitted_at_utc,
  modified_at_utc,
  top_group_node,
  group_leaf_path,
  group_category_path,
  first_group_name
FROM latest_reviews
WHERE rn = 1
ORDER BY 
  CASE WHEN COALESCE(phase, '') = '' THEN 0 ELSE 1 END,
  group_1 ASC,
  relation ASC
LIMIT 1000 OFFSET 0;
