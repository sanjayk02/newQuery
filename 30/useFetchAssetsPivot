/* hooks.ts */
import { useEffect, useMemo, useState } from 'react';
import { Asset, PivotGroup, SortDir } from './types';
import { fetchAssetsPivot } from './api';
import { Project } from '../types';

export function useFetchAssetsPivot(
  project: Project | null | undefined,
  page: number,
  rowsPerPage: number,
  sortKey: string,
  sortDir: SortDir,
  phase: string,
  assetNameKey: string,
  approvalStatuses: string[],
  workStatuses: string[],
  viewMode: 'list' | 'grouped',
): { assets: Asset[]; total: number; groups: PivotGroup[] } {
  const [assets, setAssets] = useState<Asset[]>([]);
  const [groups, setGroups] = useState<PivotGroup[]>([]);
  const [total, setTotal] = useState(0);

  // Prevent re-fetch loops when arrays are recreated
  const approvalKey = useMemo(() => approvalStatuses.join('|'), [approvalStatuses]);
  const workKey = useMemo(() => workStatuses.join('|'), [workStatuses]);

  useEffect(() => {
    if (!project || sortDir === 'none') return;

    const controller = new AbortController();

    (async () => {
      try {
        const res: any = await fetchAssetsPivot(
          project.key_name,
          page,
          rowsPerPage,
          sortKey,
          sortDir,
          phase,
          assetNameKey,
          approvalStatuses,
          workStatuses,
          viewMode,
          controller.signal,
        );

        const count =
          res?.total ??
          res?.count ??
          0;

        setTotal(Number(count) || 0);

        if (viewMode === 'grouped') {
          const serverGroups: PivotGroup[] = Array.isArray(res?.groups) ? res.groups : [];
          setGroups(serverGroups);
          setAssets([]); // important: don’t keep old list rows
        } else {
          const list: Asset[] = Array.isArray(res?.assets)
            ? res.assets
            : Array.isArray(res?.data)
              ? res.data
              : [];
          setAssets(list);
          setGroups([]); // important: don’t keep old groups
        }
      } catch (err: any) {
        if (err?.name === 'AbortError') return;
        console.error(err);
      }
    })();

    return () => controller.abort();
  }, [
    project?.key_name,
    page,
    rowsPerPage,
    sortKey,
    sortDir,
    phase,
    assetNameKey,
    approvalKey,
    workKey,
    viewMode,
  ]);

  return { assets, total, groups };
}
